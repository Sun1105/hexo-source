---
title: dump比較
category: VBA
tags: [TOOL]
date: 2025-12-23T06:45:19.352Z
---

```vbnet
' =========================================================
' 处理概要：
'   本宏用于将Sheet1和Sheet2中的SQL数据块及表头及数据内容整理导出到Sheet3。
'   主要流程：
'   1. 解析Sheet1/2所有SQL块，表名，字段，数据区块
'   2. 将Sheet1与Sheet2内SQL块进行配对
'   3. 输出比对结果至Sheet3，包括表结构、数据及判定行
'   4. 内容进行填色与边框处理
'   5. 末尾弹窗提示导出完成
' =========================================================

Sub RunBat() ' 主过程入口，执行Sheet3的导出操作

    ' 定义Sheet1对象变量
    Dim ws1 As Worksheet
    ' 定义Sheet2对象变量
    Dim ws2 As Worksheet
    ' 定义Sheet3对象变量
    Dim ws3 As Worksheet

    ' 定义Sheet1最后一行变量
    Dim lastRow1 As Long
    ' 定义Sheet2最后一行变量
    Dim lastRow2 As Long
    ' 定义Sheet3输出行计数变量，初始为1
    Dim outRow As Long

    ' 定义Sheet1 SQL块结构字典对象
    Dim tableDict1 As Object
    ' 定义Sheet2 SQL块结构字典对象
    Dim tableDict2 As Object
    ' 定义Sheet1表头字典对象
    Dim tblHeaders1 As Object
    ' 定义Sheet2表头字典对象
    Dim tblHeaders2 As Object
    ' 用于遍历SQL块key的变量
    Dim tblKey As Variant

    ' 用于循环行的变量
    Dim i As Long
    ' 临时保存字典key
    Dim key As String
    ' 临时保存SQL文本变量
    Dim sqlText As String
    ' 临时保存表头行号变量
    Dim headerRow As Long

    ' 临时保存表名
    Dim tableName As String
    ' 临时保存表字段数
    Dim colCount As Long
    ' 临时保存数据区起始行
    Dim dataStart1 As Long
    ' 临时保存数据区结束行
    Dim dataEnd1 As Long

    ' 定义表头填色青绿色常量
    Dim cyanColor As Long
    ' 定义表名行填色灰蓝色常量
    Dim grayColor As Long
    ' 定义提示行填色黄色常量
    Dim yellowColor As Long

    ' 初始化表头填色色值为青绿色
    cyanColor = RGB(135, 231, 173)
    ' 初始化表名行填色色值为灰蓝色
    grayColor = RGB(221, 235, 247)
    ' 初始化提示行填色色值为黄色
    yellowColor = RGB(255, 255, 0)

    ' 定义Sheet3实际字段起始偏移量，字段第2列开始
    Const firstColOffset As Long = 2

    ' 设置Sheet1引用对象变量
    Set ws1 = ThisWorkbook.Sheets("1")
    ' 设置Sheet2引用对象变量
    Set ws2 = ThisWorkbook.Sheets("2")
    ' 设置Sheet3引用对象变量
    Set ws3 = ThisWorkbook.Sheets("3")

    ' 清除Sheet3中全部内容，避免干扰旧数据
    ws3.Cells.Clear

    ' 新建Sheet1 SQL块结构存储字典对象
    Set tableDict1 = CreateObject("Scripting.Dictionary")
    ' 新建Sheet1表头存储字典对象
    Set tblHeaders1 = CreateObject("Scripting.Dictionary")
    ' 新建Sheet2 SQL块结构存储字典对象
    Set tableDict2 = CreateObject("Scripting.Dictionary")
    ' 新建Sheet2表头存储字典对象
    Set tblHeaders2 = CreateObject("Scripting.Dictionary")

    ' 获取Sheet1最后一行编号（用于遍历行）
    lastRow1 = ws1.Cells(ws1.Rows.Count, 1).End(xlUp).Row
    ' 获取Sheet2最后一行编号（用于遍历行）
    lastRow2 = ws2.Cells(ws2.Rows.Count, 1).End(xlUp).Row
    ' 初始化Sheet3输出行号变量
    outRow = 1

    ' 遍历Sheet1每一行，查找SELECT开头SQL块
    For i = 1 To lastRow1
        ' 判断当前行首列是否为SELECT语句
        If Left(ws1.Cells(i, 1).Value, 7) = "SELECT " Then
            ' 保存当前行SQL语句
            sqlText = ws1.Cells(i, 1).Value
            ' 表名初始为空
            tableName = ""
            ' 定义临时SQL块切割变量
            Dim sqlParts() As String
            ' 判断SQL中是否包含FROM
            If InStr(sqlText, "FROM") > 0 Then
                ' 按FROM拆分SQL字符串
                sqlParts = Split(sqlText, "FROM")
                ' 拆分结果是否存在FROM后内容
                If UBound(sqlParts) >= 1 Then
                    ' 判断FROM后是否还有WHERE
                    If InStr(sqlParts(1), "WHERE") > 0 Then
                        ' 得到表名（截取FROM与WHERE之间，去除空格）
                        tableName = Trim(Split(sqlParts(1), "WHERE")(0))
                    Else
                        ' 没有WHERE则表名取FROM后全部内容，去除空格
                        tableName = Trim(sqlParts(1))
                    End If
                End If
            End If
            ' 记录SQL语句下方的表头行号
            headerRow = i + 1
            ' 统计表头行末尾非空列的列号作为字段总数量
            colCount = ws1.Cells(headerRow, ws1.Columns.Count).End(xlToLeft).Column
            ' 设置数据区块起始行为表头下方一行
            dataStart1 = i + 2
            ' 初始化数据区块结束行就是起始行
            dataEnd1 = dataStart1
            ' 循环判断下方是否还有数据行
            Do While ws1.Cells(dataEnd1 + 1, 1).Value <> "" _
                And Left(ws1.Cells(dataEnd1 + 1, 1).Value, 7) <> "SELECT " _
                And dataEnd1 + 1 <= lastRow1
                ' 若条件成立则数据区块继续往下扩展
                dataEnd1 = dataEnd1 + 1
            Loop
            ' 用SQL文本作为字典key
            key = sqlText
            ' 判断当前SQL块是否已加入字典
            If Not tableDict1.Exists(key) Then
                ' 未存在则保存结构信息到字典
                tableDict1.Add key, Array(tableName, sqlText, headerRow, dataStart1, dataEnd1, colCount)
                ' 保存字段名表头到字典（二维数组形式）
                tblHeaders1(key) = ws1.Cells(headerRow, 1).Resize(1, colCount).Value
            End If
        End If
    Next i

    ' 遍历Sheet2每一行，同样查找SELECT开头SQL块
    For i = 1 To lastRow2
        ' 判断当前行首列是否为SELECT语句
        If Left(ws2.Cells(i, 1).Value, 7) = "SELECT " Then
            ' 保存当前行SQL语句
            sqlText = ws2.Cells(i, 1).Value
            ' 记录SQL语句下方的表头行号
            headerRow = i + 1
            ' 统计表头行末尾非空列的列号作为字段总数
            colCount = ws2.Cells(headerRow, ws2.Columns.Count).End(xlToLeft).Column
            ' 设置数据区块起始行为表头下方一行
            dataStart1 = i + 2
            ' 初始化数据区块结束行就是起始行
            dataEnd1 = dataStart1
            ' 循环判断下方是否还有数据行
            Do While ws2.Cells(dataEnd1 + 1, 1).Value <> "" _
                And Left(ws2.Cells(dataEnd1 + 1, 1).Value, 7) <> "SELECT " _
                And dataEnd1 + 1 <= lastRow2
                ' 若条件成立则数据区块继续往下扩展
                dataEnd1 = dataEnd1 + 1
            Loop
            ' 用SQL文本作为字典key
            key = sqlText
            ' 判断当前SQL块是否已加入字典
            If Not tableDict2.Exists(key) Then
                ' 未存在则保存结构信息到字典
                tableDict2.Add key, Array(sqlText, headerRow, dataStart1, dataEnd1, colCount)
                ' 保存字段名表头到字典（二维数组形式）
                tblHeaders2(key) = ws2.Cells(headerRow, 1).Resize(1, colCount).Value
            End If
        End If
    Next i

    ' 遍历Sheet1所有SQL块key，并输出至Sheet3
    For Each tblKey In tableDict1.Keys
        ' 定义临时变量保存Sheet1结构数据
        Dim arr1, arr2, header1, header2
        ' 读取Sheet1结构到临时数组
        arr1 = tableDict1(tblKey)
        ' 取得表名
        tableName = arr1(0)
        ' 取得SQL文本
        sqlText = arr1(1)
        ' 取得表头行号
        headerRow = arr1(2)
        ' 取得数据区起始行号
        dataStart1 = arr1(3)
        ' 取得数据区结束行号
        dataEnd1 = arr1(4)
        ' 取得字段总数
        colCount = arr1(5)
        ' 取得Sheet1表头（二维数组）
        header1 = tblHeaders1(tblKey)
        ' 判断Sheet2是否有同样SQL块
        Dim hasTable2 As Boolean: hasTable2 = tableDict2.Exists(tblKey)

        ' 将表名写入Sheet3当前输出行首列
        ws3.Cells(outRow, 1).Value = tableName
        ' 设置表名行背景为灰蓝
        ws3.Rows(outRow).Interior.Color = grayColor
        ' 输出行号递增一行
        outRow = outRow + 1

        ' 将SQL语句写入Sheet3当前输出行首列
        ws3.Cells(outRow, 1).Value = sqlText
        ' 输出行号递增一行
        outRow = outRow + 1

        ' 写入快捷提示文字至当前行首列
        ws3.Cells(outRow, 1).Value = "Ctrl+→"
        ' 在当前行第2列写星号
        ws3.Cells(outRow, firstColOffset).Value = "★"
        ' 当前行区域填充为黄色
        ws3.Range(ws3.Cells(outRow, 1), ws3.Cells(outRow, colCount + 1)).Interior.Color = yellowColor
        ' 输出行号递增一行
        outRow = outRow + 1

        ' 初始化字段开始列号
        Dim startFieldCol1 As Long: startFieldCol1 = 1
        ' 判断表头首格是否为空，若为空则字段实际从第2列开始
        If Trim(header1(1, 1) & "") = "" Then startFieldCol1 = 2
        ' 计算实际的字段数
        Dim actualFieldCount As Long: actualFieldCount = colCount - startFieldCol1 + 1

        ' 循环将字段名写入Sheet3表头行
        Dim iCol As Long
        For iCol = 0 To actualFieldCount - 1
            ' 写入表头字段名
            ws3.Cells(outRow, iCol + firstColOffset).Value = ws1.Cells(headerRow, startFieldCol1 + iCol).Value
            ' 设置字段单元为文本格式
            ws3.Cells(outRow, iCol + firstColOffset).NumberFormat = "@"
        Next iCol
        ' 当前表头区域颜色设青绿
        ws3.Range(ws3.Cells(outRow, firstColOffset), ws3.Cells(outRow, firstColOffset + actualFieldCount - 1)).Interior.Color = cyanColor
        ' 记录表头输出行号
        Dim headerVal1 As Long: headerVal1 = outRow
        ' 输出行号递增一行
        outRow = outRow + 1

        ' 计算Sheet1数据区块行数
        Dim dataCount1 As Long
        dataCount1 = dataEnd1 - dataStart1 + 1
        ' 循环输出Sheet1每行数据到Sheet3
        Dim dRow As Long
        For dRow = 0 To dataCount1 - 1
            For iCol = 0 To actualFieldCount - 1
                ' 写入数据行字段内容到Sheet3
                ws3.Cells(outRow, iCol + firstColOffset).Value = ws1.Cells(dataStart1 + dRow, startFieldCol1 + iCol).Text
                ' 设置为文本格式
                ws3.Cells(outRow, iCol + firstColOffset).NumberFormat = "@"
            Next iCol
            ' 输出行号递增
            outRow = outRow + 1
        Next dRow
        ' 记录Sheet1当前数据区最后一行
        Dim lastDataRow1 As Long: lastDataRow1 = outRow - 1

        ' 获取Sheet1数据区Range用于加边框
        Dim borderRange1 As Range
        Set borderRange1 = ws3.Range(ws3.Cells(headerVal1, firstColOffset), ws3.Cells(lastDataRow1, firstColOffset + actualFieldCount - 1))
        ' 先清除所有边框样式
        borderRange1.Borders.LineStyle = xlNone
        ' 上边框加细线
        With borderRange1.Borders(xlEdgeTop): .LineStyle = xlContinuous: .Weight = xlThin: End With
        ' 下边框加细线
        With borderRange1.Borders(xlEdgeBottom): .LineStyle = xlContinuous: .Weight = xlThin: End With
        ' 左边框加细线
        With borderRange1.Borders(xlEdgeLeft): .LineStyle = xlContinuous: .Weight = xlThin: End With
        ' 右边框加细线
        With borderRange1.Borders(xlEdgeRight): .LineStyle = xlContinuous: .Weight = xlThin: End With
        ' 内部竖线加细线
        With borderRange1.Borders(xlInsideVertical): .LineStyle = xlContinuous: .Weight = xlThin: End With
        ' 内部横线加细线
        With borderRange1.Borders(xlInsideHorizontal): .LineStyle = xlContinuous: .Weight = xlThin: End With

        ' 输出行号递增一行（空一行）
        outRow = outRow + 1

        ' 判断Sheet2有无配对SQL块
        If hasTable2 Then
            ' 获取Sheet2结构到临时变量
            arr2 = tableDict2(tblKey)
            ' 取得表头行号
            Dim headerRow2 As Long: headerRow2 = arr2(1)
            ' 取得数据区起始行号
            Dim dataStart2 As Long: dataStart2 = arr2(2)
            ' 取得数据区结束行号
            Dim dataEnd2 As Long: dataEnd2 = arr2(3)
            ' 取得字段总数
            Dim colCount2 As Long: colCount2 = arr2(4)
            ' 取得Sheet2表头（二维数组）
            header2 = tblHeaders2(tblKey)

            ' 初始化Sheet2字段开始列号
            Dim startFieldCol2 As Long: startFieldCol2 = 1
            ' 判断表头首格是否为空，若为空则从第2列开始
            If Trim(header2(1, 1) & "") = "" Then startFieldCol2 = 2
            ' Sheet2实际字段数
            Dim actualFieldCount2 As Long: actualFieldCount2 = colCount2 - startFieldCol2 + 1

            ' 将SQL语句写入当前行
            ws3.Cells(outRow, 1).Value = sqlText
            ' 输出行号递增
            outRow = outRow + 1

            ' 循环写入字段名至表头
            For iCol = 0 To actualFieldCount2 - 1
                ws3.Cells(outRow, iCol + firstColOffset).Value = ws2.Cells(headerRow2, startFieldCol2 + iCol).Value
                ws3.Cells(outRow, iCol + firstColOffset).NumberFormat = "@"
            Next iCol
            ' 表头区域设青绿色
            ws3.Range(ws3.Cells(outRow, firstColOffset), ws3.Cells(outRow, firstColOffset + actualFieldCount2 - 1)).Interior.Color = cyanColor
            ' 记录表头输出行号
            Dim headerVal2 As Long: headerVal2 = outRow
            ' 输出行号递增一行
            outRow = outRow + 1

            ' 计算Sheet2数据区块行数
            Dim dataCount2 As Long: dataCount2 = dataEnd2 - dataStart2 + 1
            ' 记录Sheet2数据区当前起始行（判定用）
            Dim curDataRow2Start As Long: curDataRow2Start = outRow
            ' 循环输出Sheet2每行数据到Sheet3
            For dRow = 0 To dataCount2 - 1
                For iCol = 0 To actualFieldCount2 - 1
                    ws3.Cells(outRow, iCol + firstColOffset).Value = ws2.Cells(dataStart2 + dRow, startFieldCol2 + iCol).Text
                    ws3.Cells(outRow, iCol + firstColOffset).NumberFormat = "@"
                Next iCol
                outRow = outRow + 1
            Next dRow

            ' 记录Sheet2当前最后一行号
            Dim lastDataRow2 As Long: lastDataRow2 = outRow - 1
            ' 获取Sheet2数据区Range用于加边框
            Dim borderRange2 As Range
            Set borderRange2 = ws3.Range(ws3.Cells(headerVal2, firstColOffset), ws3.Cells(lastDataRow2, firstColOffset + actualFieldCount2 - 1))
            borderRange2.Borders.LineStyle = xlNone
            With borderRange2.Borders(xlEdgeTop): .LineStyle = xlContinuous: .Weight = xlThin: End With
            With borderRange2.Borders(xlEdgeBottom): .LineStyle = xlContinuous: .Weight = xlThin: End With
            With borderRange2.Borders(xlEdgeLeft): .LineStyle = xlContinuous: .Weight = xlThin: End With
            With borderRange2.Borders(xlEdgeRight): .LineStyle = xlContinuous: .Weight = xlThin: End With
            With borderRange2.Borders(xlInsideVertical): .LineStyle = xlContinuous: .Weight = xlThin: End With
            With borderRange2.Borders(xlInsideHorizontal): .LineStyle = xlContinuous: .Weight = xlThin: End With

            ' Sheet1与Sheet2逐行逐字段比对
            Dim maxRow As Long: maxRow = Application.WorksheetFunction.Max(dataCount1, dataCount2)
            ' 输出行号递增一行
            outRow = outRow + 1
            ' 循环判定每行所有字段值是否一致
            For dRow = 0 To maxRow - 1
                ' 第1行输出判定标题
                If dRow = 0 Then ws3.Cells(outRow, 1).Value = "判定"
                For iCol = 0 To actualFieldCount - 1
                    ' Sheet1当前字段值
                    Dim val1 As String
                    If dRow < dataCount1 Then
                        val1 = ws1.Cells(dataStart1 + dRow, startFieldCol1 + iCol).Text
                    Else
                        val1 = ""
                    End If
                    ' Sheet2当前字段值
                    Dim val2 As String
                    If dRow < dataCount2 Then
                        val2 = ws2.Cells(dataStart2 + dRow, startFieldCol2 + iCol).Text
                    Else
                        val2 = ""
                    End If
                    ' 判定当前字段值是否全等
                    If val1 = val2 Then
                        ws3.Cells(outRow, iCol + firstColOffset).Value = "TRUE"
                    Else
                        ws3.Cells(outRow, iCol + firstColOffset).Value = "FALSE"
                    End If
                Next iCol
                ' 输出行号递增
                outRow = outRow + 1
            Next dRow

            ' 判定区块输出后再空一行分隔
            outRow = outRow + 1

        Else
            ' 如果Sheet2无对应SQL块，写出提示
            ws3.Cells(outRow, 1).Value = "Sheet2見つかりません"
            ' 空两行做分隔
            outRow = outRow + 2
        End If

        ' 多空一行用于多个表间分隔
        outRow = outRow + 1
    Next tblKey

    ' 统一Sheet3全体设Meiryo UI字体
    ws3.Cells.Font.Name = "Meiryo UI"
    ' 统一Sheet3全体设为文本格式
    ws3.Cells.NumberFormat = "@"

    ' 导出完毕弹出提示窗口
    MsgBox "Sheet3導出完了"

End Sub
```
