---
title: JSON Key-Value 提取及处理工具
date: 2026-02-19T12:52:54.994Z
categories: [TOOL]
tags: [VBA]
---

## 1. Java 程序

### 1.1 打包命令

```bash
# 编译
javac -d out JsonKeyValueExtractorGui.java

# 生成 manifest
echo Main-Class: JsonKeyValueExtractorGui > manifest.txt

# 打包 jar
jar cfm json2txt.jar manifest.txt -C out .
```

### 1.2 Java 源代码

```java
import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.*;
import java.util.prefs.Preferences;

/**
 * JsonKeyValueExtractorGui
 * 用于从JSON文本中提取Key-Value，并输出到TXT文件
 * 支持记忆上次保存路径，初次为 D:\Json\text.txt
 */
public class JsonKeyValueExtractorGui {
    // 偏好项的键名，用于存储上次保存路径
    private static final String PREF_KEY_LAST_PATH = "lastSavePath";
    // 默认的初始保存路径
    private static final String DEFAULT_PATH = "D:\\Json\\text.txt";
    // Preferences对象，基于当前类所在包，用于持久化保存/读取参数
    private static Preferences prefs = Preferences.userNodeForPackage(JsonKeyValueExtractorGui.class);

    // 主方法，程序入口
    public static void main(String[] args) {
        // 以线程安全方式在Swing UI线程中执行GUI创建
        SwingUtilities.invokeLater(JsonKeyValueExtractorGui::createAndShowGui);
    }

    // 创建和显示主界面
    private static void createAndShowGui() {
        JFrame frame = new JFrame("JSON Key-Value 提取器"); // 新建窗口，设置标题
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE); // 关闭窗口时退出程序
        frame.setSize(600, 500); // 设置窗口尺寸
        frame.setLocationRelativeTo(null); // 居中显示窗口

        JTextArea inputArea = new JTextArea(20, 50); // 创建20行50列的多行文本输入区
        JScrollPane scrollPane = new JScrollPane(inputArea); // 将文本区放入带滚动条的面板
        JButton processButton = new JButton("确定并输出到TXT"); // 新建按钮
        JLabel infoLabel = new JLabel("请粘贴Postman返回的JSON，然后点击“确定并输出到TXT”"); // 顶部提示

        frame.setLayout(new BorderLayout()); // 设置窗口布局为BorderLayout
        frame.add(infoLabel, BorderLayout.NORTH); // 将提示标签放在顶部
        frame.add(scrollPane, BorderLayout.CENTER); // 将文本区放在中间
        frame.add(processButton, BorderLayout.SOUTH); // 将按钮放到底部

        // 为按钮添加点击事件监听器
        processButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                String inputText = inputArea.getText(); // 获取文本区输入内容
                if (inputText.trim().isEmpty()) { // 判断输入内容是否为空
                    // 如果为空，弹出错误对话框并退出事件
                    JOptionPane.showMessageDialog(frame, "输入内容不能为空", "错误", JOptionPane.ERROR_MESSAGE);
                    return;
                }

                String lastPath = prefs.get(PREF_KEY_LAST_PATH, DEFAULT_PATH); // 获取上次保存路径，如无则用默认
                File lastFile = new File(lastPath); // 构造文件对象

                JFileChooser fileChooser = new JFileChooser(); // 新建文件选择器
                fileChooser.setDialogTitle("选择输出txt文件保存位置"); // 对话框标题

                // 设置文件选择器的默认目录
                if (lastFile.getParentFile() != null && lastFile.getParentFile().exists()) {
                    fileChooser.setCurrentDirectory(lastFile.getParentFile()); // 父目录存在则设为默认目录
                } else {
                    lastFile.getParentFile().mkdirs(); // 如果目录不存在则先创建
                    fileChooser.setCurrentDirectory(lastFile.getParentFile()); // 再设为默认目录
                }
                fileChooser.setSelectedFile(new File(lastFile.getName())); // 默认文件名为上次名

                int userSelection = fileChooser.showSaveDialog(frame); // 显示保存对话框，等待用户选择

                if (userSelection == JFileChooser.APPROVE_OPTION) { // 用户点击“保存”
                    File fileToSave = fileChooser.getSelectedFile(); // 获取用户选定的文件
                    // 使用UTF-8编码写入文件
                    try (BufferedWriter writer = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(fileToSave), "UTF-8"))) {
                        String processResult = processJsonLines(inputText); // 处理输入内容为Key-Value串
                        writer.write(processResult); // 写入文件
                        // 提示保存成功及保存路径
                        JOptionPane.showMessageDialog(frame, "处理完成！结果已保存到:\n" + fileToSave.getAbsolutePath(), "成功", JOptionPane.INFORMATION_MESSAGE);
                        prefs.put(PREF_KEY_LAST_PATH, fileToSave.getAbsolutePath()); // 记忆本次保存路径
                    } catch (Exception ex) { // 捕捉写文件过程异常
                        JOptionPane.showMessageDialog(frame, "输出时出错: " + ex.getMessage(), "错误", JOptionPane.ERROR_MESSAGE);
                    }
                }
            }
        });

        frame.setVisible(true); // 显示主窗口
    }

    /**
     * 处理输入字符串，逐行提取key和value
     * @param input 输入的JSON文本
     * @return 获取的"key[TAB]value"格式的内容，每行一个键值对
     */
    private static String processJsonLines(String input) {
        StringBuilder result = new StringBuilder(); // 用于拼接最后的全部输出字符串
        String[] lines = input.split("\\r?\\n"); // 将输入按行切分，兼容Windows和Unix换行
        for (String line : lines) { // 遍历每一行
            String trimmed = line.trim(); // 去掉首尾空格
            int colonIdx = trimmed.indexOf(':'); // 查找第一个冒号下标
            if (colonIdx > 0) { // 仅处理含有冒号的行
                String beforeColon = trimmed.substring(0, colonIdx).trim(); // :前为key部分（含引号等）
                String afterColon = trimmed.substring(colonIdx + 1).trim(); // :后为value部分（含逗号或引号等）
                String key = null, value = ""; // 初始化key和value变量
                int firstQuote = beforeColon.indexOf('"'); // 查找key第一个引号
                int secondQuote = beforeColon.indexOf('"', firstQuote + 1); // 查找key第二个引号
                if (firstQuote >= 0 && secondQuote > firstQuote) { // 确实被""包围
                    String possibleKey = beforeColon.substring(firstQuote + 1, secondQuote); // 提取引号内key名
                    if (possibleKey.matches("[a-zA-Z0-9_]+")) {  // key只允许英文字母、数字、下划线
                        key = possibleKey; // 提取成功
                    }
                }
                if (key != null) { // 如果key已经提取
                    afterColon = afterColon.replaceAll(",$", ""); // 去除末尾逗号
                    if (afterColon.startsWith("\"")) { // value是字符串
                        int vq1 = afterColon.indexOf('"'); // 第一个引号
                        int vq2 = afterColon.indexOf('"', vq1 + 1); // 第二个引号
                        if (vq1 >= 0 && vq2 > vq1)
                            value = afterColon.substring(vq1 + 1, vq2); // 提取引号内的字符串value
                    }
                    // 追加到输出，格式key+TAB+value+换行
                    result.append(key).append("\t").append(value).append("\n");
                }
            }
        }
        return result.toString(); // 返回全部结果
    }
}
```

## 2. RunBat (启动 Java 程序)

```vba
'【功能】运行指定文件夹下的“起動.bat”批处理文件，如果文件不存在则弹窗并写入日志
Public Sub RunBat(folderPath As String)
    ' 声明变量：wsh为脚本Shell对象，batPath为批处理文件路径
    Dim wsh As Object
    Dim batPath As String
    ' 拼接批处理文件完整路径
    batPath = folderPath & "\起動.bat"
    
    ' 判断起動.bat文件是否存在
    If Dir(batPath) <> "" Then
        ' 文件存在，创建WScript.Shell对象
        Set wsh = CreateObject("WScript.Shell")
        ' 用cmd切换到目标目录并运行起動.bat，窗口显示，等待命令完成
        wsh.Run "cmd.exe /k ""cd /d " & folderPath & " & 起動.bat""", 1, True
    Else
        ' 文件不存在，弹窗提示
        MsgBox "文件不存在：" & batPath, vbExclamation
        ' 记录错误到日志
        LogError "文件不存在：" & batPath
    End If
End Sub

'【功能】尝试打开指定的Excel文件（相对路径），如不存在则提示并写入日志
Public Sub OpenExcelTool(relativePath As String)
    ' 声明变量：filePath为要打开的Excel文件的完整路径
    Dim filePath As String
    ' 以当前工作簿的目录为基础拼接目标文件路径
    filePath = ThisWorkbook.Path & "\" & relativePath
    
    ' 判断Excel文件是否存在
    If Dir(filePath) <> "" Then
        ' 存在则直接以新窗口方式打开
        Workbooks.Open filePath
    Else
        ' 不存在则弹窗提示并写入日志
        MsgBox "Excel 文件不存在：" & filePath, vbExclamation
        LogError "Excel 文件不存在：" & filePath
    End If
End Sub

'【功能】将错误信息写入当前工作簿目录下的ErrorLog.txt文件，每条带有时间戳
Public Sub LogError(errorMsg As String)
    ' 声明变量：logFile为日志文件路径，fNum为可用文件号
    Dim logFile As String
    Dim fNum As Integer
    ' 拼接日志文件路径
    logFile = ThisWorkbook.Path & "\ErrorLog.txt"
    
    ' 获取空闲文件号，追加方式打开日志文件（无则创建）
    fNum = FreeFile
    Open logFile For Append As #fNum
    ' 写入内容：当前时间 + 错误信息
    Print #fNum, Now & " - " & errorMsg
    ' 关闭文件
    Close #fNum
End Sub

'【功能】用于一键运行D:\Json目录下的起動.bat批处理文件
Public Sub RunServerBat()
    ' 直接调用RunBat子程序，参数为D:\Json
    RunBat "D:\Json"
End Sub
```

## 3. ImportKeyValueFromTxt (读取 Java 程序生成的文件内容)

```vba
'【功能】导入由Java工具导出的key-value文本文件，将内容填入Sheet "2" 的A2/B2起始的列中
Sub ImportKeyValueFromTxt()
    ' 声明工作表变量
    Dim ws As Worksheet
    ' 存放所有行的字符串数组
    Dim arrLines() As String
    ' 用于存储完整文件内容的字符串
    Dim txt As String
    ' 循环变量
    Dim i As Long
    ' 存储每行分割后的键值对
    Dim kv As Variant
    ' 用于文件读取的ADODB对象
    Dim fso As Object
    ' 存储选中的文件路径
    Dim filePath As String

    ' 弹出文件选择对话框，让用户选择txt文件
    filePath = Application.GetOpenFilename("Text Files (*.txt),*.txt", , "ファイルを選択してください")
    ' 如果用户按了取消，则退出
    If filePath = "False" Then Exit Sub

    ' 错误捕获：尝试获取名为"2"的工作表
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("2")
    On Error GoTo 0
    ' 没有找到Sheet "2"时提醒并退出
    If ws Is Nothing Then
        MsgBox "シート２が見つかりません", vbExclamation
        Exit Sub
    End If

    ' 激活目标工作表
    ws.Activate

    ' 清除原有A2:B列的数据，防止残留
    ws.Range("A2:B" & ws.Rows.Count).ClearContents

    ' 创建ADODB.Stream对象以utf-8编码方式读取文件
    Set fso = CreateObject("ADODB.Stream")
    fso.Charset = "utf-8"
    fso.Open
    fso.LoadFromFile filePath      ' 载入用户选择的文件
    txt = fso.ReadText             ' 读入全部文本内容
    fso.Close

    ' 用LF('\n')分割成每一行的数组
    arrLines = Split(txt, vbLf)

    ' 按行写入Excel，A2起为key，B2起为value
    For i = 0 To UBound(arrLines)
        If Trim(arrLines(i)) <> "" Then                 ' 跳过空行
            kv = Split(arrLines(i), vbTab)              ' 用Tab分割为数组
            ws.Cells(i + 2, 1).Value = kv(0)            ' A列写key
            If UBound(kv) >= 1 Then
                ws.Cells(i + 2, 2).Value = kv(1)        ' B列写value（如有）
            Else
                ws.Cells(i + 2, 2).Value = ""           ' 否则B列空
            End If
        End If
    Next i

    ' 弹窗提示处理完成
    MsgBox "取得完了", vbInformation
End Sub
```

## 4. Mapping (项目与值进行匹配)

```vba
Option Explicit

'【功能】规范化Key值（去除全角空格并做Trim）
Private Function CleanKey(ByVal v As Variant) As String
    Dim s As String
    ' 转换为字符串
    s = CStr(v)
    ' 去除全角空格（ChrW(12288) 是全角空格）
    s = Replace(s, ChrW(12288), "")
    ' 去除前后半角空格
    s = Trim(s)
    ' 返回处理后的字符串作为Key
    CleanKey = s
End Function

'【功能】将Sheet2的key/value批量填入Sheet1（并做key清洗，填充前清除旧内容）
Public Sub FillItemsAndValues()
    ' wsSrc：来源sheet2，wsTgt：目标sheet1
    Dim wsSrc As Worksheet, wsTgt As Worksheet
    Dim lastSrc As Long, lastTgt As Long ' 数据的最后一行序号
    Dim r As Long                        ' 行循环变量
    Dim dict As Object                   ' 字典，存储清洗后的key与原始key/value
    Dim k As String                      ' 经过CleanKey处理后的key
    Dim itemName As Variant, itemValue As Variant
    
    ' 设置目标（1）和来源（2）工作表对象
    Set wsTgt = ThisWorkbook.Sheets("1")
    Set wsSrc = ThisWorkbook.Sheets("2")
    
    ' 查找Sheet2最后一行（A列）
    lastSrc = wsSrc.Cells(wsSrc.Rows.Count, 1).End(xlUp).Row
    ' 查找Sheet1最后一行（A列）
    lastTgt = wsTgt.Cells(wsTgt.Rows.Count, 1).End(xlUp).Row
    
    ' 创建Scripting.Dictionary对象保存key和(key, value)
    Set dict = CreateObject("Scripting.Dictionary")
    
    ' 将Sheet2中A、B列的全部数据写入字典，以规范化key为键
    For r = 2 To lastSrc
        k = CleanKey(wsSrc.Cells(r, 1).Value)
        If Len(k) > 0 Then
            itemName = wsSrc.Cells(r, 1).Value
            itemValue = wsSrc.Cells(r, 2).Value
            dict(k) = Array(itemName, itemValue)
        End If
    Next r
    
    ' 清空Sheet1中目标填充列（B列、D列；从第2行到底）
    wsTgt.Range(wsTgt.Cells(2, 2), wsTgt.Cells(lastTgt, 2)).ClearContents
    wsTgt.Range(wsTgt.Cells(2, 4), wsTgt.Cells(lastTgt, 4)).ClearContents
    
    ' 提高效率：关闭屏幕刷新及自动计算
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    
    ' 用Sheet1每一行A列的key（做清洗）去字典里查找，
    ' 找到就将原始key写到B列，对应value写到D列
    For r = 2 To lastTgt
        k = CleanKey(wsTgt.Cells(r, 1).Value)
        If dict.Exists(k) Then
            wsTgt.Cells(r, 2).Value = dict(k)(0) ' B列写原始key
            wsTgt.Cells(r, 4).Value = dict(k)(1) ' D列写value
        End If
    Next r
    
    ' 还原Excel设置
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    
    ' 处理完成，弹窗提示
    MsgBox "マッピング完了", vbInformation
End Sub
```