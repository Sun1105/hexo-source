<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <!-- ËÆæÁΩÆÂ≠óÁ¨¶ÈõÜ‰∏∫ UTF-8 -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄÔºåÈÄÇÈÖçÁßªÂä®ËÆæÂ§á -->

  <!-- È°µÈù¢Ê†áÈ¢ò -->
  <!-- Â¶ÇÊûúÂΩìÂâçÈ°µÈù¢ÊúâÊ†áÈ¢òÔºåÂàôÊòæÁ§∫ "È°µÈù¢Ê†áÈ¢ò | ÁΩëÁ´ôÊ†áÈ¢ò" -->
  <!-- Âê¶ÂàôÂè™ÊòæÁ§∫ÁΩëÁ´ôÊ†áÈ¢ò config.title -->
  <title>
    <%= page.title ? `${page.title} | ${config.title}` : config.title %>
  </title>

  <!-- È°µÈù¢ÊèèËø∞ÔºåÁî®‰∫é SEO -->
  <meta name="description" content="<%= config.description || '‰∏™‰∫∫ÊäÄÊúØÁ¨îËÆ∞‰∏éÂ≠¶‰π†ËÆ∞ÂΩï' %>">

  <!-- ===== ÂÖ®Â±ÄÊ†∑ÂºèÂºïÂÖ• ===== -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet" href="/css/post-list.css">
  <link rel="stylesheet" href="/css/page.css">
  <link rel="stylesheet" href="/css/category.css">
  <link rel="stylesheet" href="/css/archive.css">
  <link rel="stylesheet" href="/css/layout.css">
  <!-- ÂêÑÊ®°ÂùóÊ†∑ÂºèÔºå‰æø‰∫éÁª¥Êä§ -->

  <!-- ===== Â≠ó‰Ωì‰∏éÂõæÊ†á ===== -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
  <!-- ÁΩëÁ´ô favicon Âíå Google Â≠ó‰Ωì -->

  <!-- ===== ÁôªÂΩïÁä∂ÊÄÅÊ£ÄÊü• ===== -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const onLoginPage = window.location.pathname.startsWith("/login");
      if (!onLoginPage && !localStorage.getItem("isLoggedIn")) {
        window.location.href = "/login/";
      }
      // Â¶ÇÊûúÊú™ÁôªÂΩï‰∏î‰∏çÂú®ÁôªÂΩïÈ°µÔºåËá™Âä®Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ
    });
  </script>
</head>

<body>
  <% if (!page.simpleLayout) { %>
    <!-- ===== È°∂ÈÉ®ÂØºËà™Ê†è ===== -->
    <%- partial('_partial/header') %>
    <!-- ÂØºÂÖ• header ÈÉ®ÂàÜÊ®°Êùø -->

    <!-- ===== ‰æßËæπÊ†è ===== -->
    <%- partial('_partial/sidebar') %>
    <!-- ÂØºÂÖ• sidebar ÈÉ®ÂàÜÊ®°Êùø -->
  <% } %>

  <!-- ===== ‰∏ª‰ΩìÂÜÖÂÆπÂå∫ ===== -->
  <main id="main-content">
    <%- body %>
    <!-- Ê∏≤ÊüìÂΩìÂâçÈ°µÈù¢ÂÜÖÂÆπ -->
    <!-- <%- %> ‰øùËØÅ HTML Ê≠£Â∏∏Ê∏≤ÊüìÔºå‰∏çËΩ¨‰πâ -->

    <section id="study-main-panel" style="display:none; margin-top:24px;">
      <h2 style="font-size:1.2rem; margin-bottom:12px;">üìö Â≠¶‰π†ËµÑÊñôÂàóË°®</h2>
      <div id="study-main-groups">
        <div class="study-group collapsed">
          <div class="study-group-title">Ê†áÂàù‰∏ä</div>
          <ul id="study-main-bcs">
            <li>ÊöÇÊó†Êñá‰ª∂</li>
          </ul>
        </div>
        <div class="study-group collapsed">
          <div class="study-group-title">Ê†áÂàù‰∏ã</div>
          <ul id="study-main-bcx">
            <li>ÊöÇÊó†Êñá‰ª∂</li>
          </ul>
        </div>
        <div class="study-group collapsed">
          <div class="study-group-title">Ê†á‰∏≠‰∏ä</div>
          <ul id="study-main-bzs">
            <li>ÊöÇÊó†Êñá‰ª∂</li>
          </ul>
        </div>
        <div class="study-group collapsed">
          <div class="study-group-title">Ê†á‰∏≠‰∏ã</div>
          <ul id="study-main-bzx">
            <li>ÊöÇÊó†Êñá‰ª∂</li>
          </ul>
        </div>
        <div class="study-group collapsed">
          <div class="study-group-title">Ê†áÈ´ò‰∏ä</div>
          <ul id="study-main-bgs">
            <li>ÊöÇÊó†Êñá‰ª∂</li>
          </ul>
        </div>
        <div class="study-group collapsed">
          <div class="study-group-title">Ê†áÈ´ò‰∏ã</div>
          <ul id="study-main-bgx">
            <li>ÊöÇÊó†Êñá‰ª∂</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <div id="study-viewer" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.9);z-index:2000;align-items:center;justify-content:center;">
    <div style="position:relative;width:96vw;max-width:1200px;max-height:96vh;background:#020617;padding:10px 16px 14px;border-radius:10px;box-shadow:0 22px 70px rgba(0,0,0,0.7);display:flex;flex-direction:column;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;color:#e5e7eb;font-size:0.95rem;">
        <span id="study-viewer-title" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:75vw;"></span>
        <button id="study-viewer-close" style="border:none;background:transparent;color:#e5e7eb;font-size:1.3rem;cursor:pointer;line-height:1;">√ó</button>
      </div>
      <div style="flex:1;display:flex;align-items:center;justify-content:center;margin:4px 0 6px;">
        <img id="study-viewer-img" src="" alt="" style="max-width:100%;max-height:84vh;border-radius:4px;background:#020617;" />
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;">
        <button id="study-viewer-prev" style="min-width:80px;padding:6px 12px;border-radius:6px;border:none;background:#1e293b;color:#e5e7eb;cursor:pointer;font-size:0.9rem;">‰∏ä‰∏ÄÂº†</button>
        <button id="study-viewer-next" style="min-width:80px;padding:6px 12px;border-radius:6px;border:none;background:#1e293b;color:#e5e7eb;cursor:pointer;font-size:0.9rem;">‰∏ã‰∏ÄÂº†</button>
      </div>
    </div>
  </div>

  <!-- ===== ÂÖ®Â±ÄËÑöÊú¨Âå∫Âüü ===== -->
  <script>
    function logout() {
      localStorage.removeItem("isLoggedIn");
      window.location.href = "/login/";
    }

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function toggleMenu() {
      const menu = document.querySelector('header.top-nav .menu');
      if (menu) {
        menu.classList.toggle('show');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const uploadInput = document.getElementById('pdf-upload-input');
      const uploadBtn = document.getElementById('pdf-upload-btn');
      const typeSelect = document.getElementById('file-type-select');
      const categorySelect = document.getElementById('category-select');
      const studyPanel = document.getElementById('study-main-panel');
      const studyMainBtn = document.getElementById('study-main-btn');
      const sidebarStudyTitle = document.getElementById('sidebar-study-title');
      const viewer = document.getElementById('study-viewer');
      const viewerImg = document.getElementById('study-viewer-img');
      const viewerTitle = document.getElementById('study-viewer-title');
      const viewerPrev = document.getElementById('study-viewer-prev');
      const viewerNext = document.getElementById('study-viewer-next');
      const viewerClose = document.getElementById('study-viewer-close');

      const studyFilesMap = {};
      let currentCategory = null;
      let currentIndex = 0;

      const CATEGORY_CONFIG = [
        { key: 'bcs', label: 'Ê†áÂàù‰∏ä' },
        { key: 'bcx', label: 'Ê†áÂàù‰∏ã' },
        { key: 'bzs', label: 'Ê†á‰∏≠‰∏ä' },
        { key: 'bzx', label: 'Ê†á‰∏≠‰∏ã' },
        { key: 'bgs', label: 'Ê†áÈ´ò‰∏ä' },
        { key: 'bgx', label: 'Ê†áÈ´ò‰∏ã' }
      ];

      function getListEl(key) {
        return document.getElementById('study-' + key);
      }

      function getMainListEl(key) {
        return document.getElementById('study-main-' + key);
      }

      function updateAccept() {
        if (!uploadInput || !typeSelect) return;
        if (typeSelect.value === 'image') {
          uploadInput.accept = 'image/*';
        } else {
          uploadInput.accept = 'application/pdf';
        }
      }

      function isLocalhost() {
        return (
          location.hostname === 'localhost' ||
          location.hostname === '127.0.0.1' ||
          location.hostname === ''
        );
      }

      async function fetchStudyList(catKey) {
        if (!isLocalhost()) {
          try {
            const apiRes = await fetch('/api/study-list?category=' + encodeURIComponent(catKey));
            if (apiRes.ok) {
              const apiData = await apiRes.json();
              if (Array.isArray(apiData.files)) {
                return apiData.files;
              }
            }
          } catch (e) {
          }
        }

        try {
          const ghRes = await fetch(
            'https://api.github.com/repos/Sun1105/hexo-source/contents/source/study/' + catKey
          );
          if (!ghRes.ok) {
            return [];
          }
          const ghData = await ghRes.json();
          return Array.isArray(ghData) ? ghData : [];
        } catch (e) {
          return [];
        }
      }

      async function loadResources() {
        for (const cat of CATEGORY_CONFIG) {
          const sideList = getListEl(cat.key);
          const mainList = getMainListEl(cat.key);

          if (sideList) {
            sideList.innerHTML = '<li>Âä†ËΩΩ‰∏≠...</li>';
          }
          if (mainList) {
            mainList.innerHTML = '<li>Âä†ËΩΩ‰∏≠...</li>';
          }

          const list = await fetchStudyList(cat.key);
          const files = Array.isArray(list)
            ? list.filter(file => file.name && /\.(pdf|png|jpe?g|gif|webp|svg)$/i.test(file.name))
            : [];

          studyFilesMap[cat.key] = files;

          if (!files.length) {
            if (sideList) sideList.innerHTML = '<li>ÊöÇÊó†Êñá‰ª∂</li>';
            if (mainList) mainList.innerHTML = '<li>ÊöÇÊó†Êñá‰ª∂</li>';
            continue;
          }

          const parts = files.map((file, index) => {
            const href =
              file.download_url ||
              file.html_url ||
              (file.path ? '/' + file.path.replace(/^source\//, '') : '#');
            return (
              '<li>' +
                '<a href="' + href + '" target="_blank" class="study-file-link" data-category="' +
                cat.key + '" data-index="' + index + '">' +
                  '<span class="sidebar-name">' + file.name + '</span>' +
                '</a>' +
              '</li>'
            );
          });

          if (sideList) {
            sideList.innerHTML = parts.join('');
            bindStudyLinks(sideList);
          }
          if (mainList) {
            mainList.innerHTML = parts.join('');
            bindStudyLinks(mainList);
          }
        }
      }

      loadResources();

      if (typeSelect) {
        typeSelect.addEventListener('change', updateAccept);
        updateAccept();
      }

      function openViewer(category, index) {
        const list = studyFilesMap[category] || [];
        if (!list.length) return;

        if (index < 0) index = 0;
        if (index >= list.length) index = list.length - 1;

        const file = list[index];
        const href =
          file.download_url ||
          file.html_url ||
          (file.path ? '/' + file.path.replace(/^source\//, '') : '#');

        currentCategory = category;
        currentIndex = index;

        if (viewerImg) {
          viewerImg.src = href;
        }
        if (viewerTitle) {
          viewerTitle.textContent = file.name || '';
        }
        if (viewer) {
          viewer.style.display = 'flex';
        }

        if (viewerPrev) {
          viewerPrev.disabled = index <= 0;
        }
        if (viewerNext) {
          viewerNext.disabled = index >= list.length - 1;
        }
      }

      function closeViewer() {
        if (viewer) {
          viewer.style.display = 'none';
        }
      }

      function showOffset(delta) {
        if (!currentCategory) return;
        openViewer(currentCategory, currentIndex + delta);
      }

      function onStudyLinkClick(event) {
        if (!viewer || !viewerImg) return;
        event.preventDefault();
        const category = this.getAttribute('data-category');
        const index = parseInt(this.getAttribute('data-index'), 10) || 0;
        openViewer(category, index);
      }

      function bindStudyLinks(container) {
        const links = container.querySelectorAll('a.study-file-link');
        links.forEach(link => {
          link.addEventListener('click', onStudyLinkClick);
        });
      }

      function showStudyPanel() {
        if (!studyPanel) return;
        const main = document.getElementById('main-content');
        if (main) {
          const children = Array.from(main.children);
          children.forEach(child => {
            if (child.id === 'study-main-panel') {
              child.style.display = 'block';
            } else {
              child.style.display = 'none';
            }
          });
          main.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      if (studyMainBtn) {
        studyMainBtn.addEventListener('click', () => {
          showStudyPanel();
          loadResources();
        });
      }

      // Â∑¶‰æß‚ÄúÂ≠¶‰π†ËµÑÊñô‚ÄùÊ†áÈ¢òÂè™Ë¥üË¥£Â±ïÂºÄ‰æßËæπÊ†èÔºå‰∏çÂÜçÂº∫Âà∂ÂàáÊç¢‰∏ªÂÜÖÂÆπ

      const groupTitles = document.querySelectorAll('.study-group-title');
      groupTitles.forEach(title => {
        const group = title.parentElement;
        const list = group.querySelector('ul');
        if (!list) return;
        title.addEventListener('click', () => {
          group.classList.toggle('collapsed');
        });
      });

      if (uploadBtn && uploadInput) {
        uploadBtn.addEventListener('click', () => {
          if (!uploadInput.files || !uploadInput.files.length) {
            alert('ËØ∑ÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÊñá‰ª∂');
            return;
          }

          const files = Array.from(uploadInput.files);
          const type = typeSelect ? typeSelect.value : 'pdf';
          const category = categorySelect ? categorySelect.value : 'bcs';

          const invalid = files.some(file => {
            if (type === 'pdf') {
              return !file.name.toLowerCase().endsWith('.pdf');
            }
            if (type === 'image') {
              return !file.type.startsWith('image/');
            }
            return true;
          });

          if (invalid) {
            if (type === 'pdf') {
              alert('‰ªÖÊîØÊåÅÊâ©Â±ïÂêç‰∏∫ .pdf ÁöÑÊñá‰ª∂');
            } else if (type === 'image') {
              alert('‰ªÖÊîØÊåÅÂõæÁâáÊñá‰ª∂');
            } else {
              alert('Êñá‰ª∂Á±ªÂûã‰∏çÊîØÊåÅ');
            }
            return;
          }

          uploadBtn.disabled = true;
          uploadBtn.textContent = '‰∏ä‰º†‰∏≠...';

          let successCount = 0;
          let failCount = 0;

          function uploadAt(index) {
            if (index >= files.length) {
              const message = '‰∏ä‰º†ÂÆåÊàêÔºöÊàêÂäü ' + successCount + ' ‰∏™ÔºåÂ§±Ë¥• ' + failCount + ' ‰∏™';
              alert(message);
              uploadInput.value = '';
              loadResources();
              uploadBtn.disabled = false;
              uploadBtn.textContent = '‰∏ä‰º†Êñá‰ª∂';
              return;
            }

            const file = files[index];
            const reader = new FileReader();

            reader.onload = event => {
              (async () => {
                try {
                  const arrayBuffer = event.target.result;
                  const bytes = new Uint8Array(arrayBuffer);
                  let binary = '';
                  for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                  }
                  const base64 = btoa(binary);

                  const res = await fetch('/api/upload-pdf', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      filename: file.name,
                      content: base64,
                      type,
                      category
                    })
                  });

                  if (res.ok) {
                    successCount += 1;
                  } else {
                    try {
                      const errData = await res.json();
                      if (errData && errData.error) {
                        console.error('‰∏ä‰º†Â§±Ë¥•', file.name, errData.error);
                      }
                    } catch (e2) {}
                    failCount += 1;
                  }
                } catch (e) {
                  failCount += 1;
                } finally {
                  uploadAt(index + 1);
                }
              })();
            };

            reader.onerror = () => {
              failCount += 1;
              uploadAt(index + 1);
            };

            reader.readAsArrayBuffer(file);
          }

          uploadAt(0);
        });
      }

      if (viewerClose) {
        viewerClose.addEventListener('click', () => {
          closeViewer();
        });
      }

      if (viewerPrev) {
        viewerPrev.addEventListener('click', () => {
          showOffset(-1);
        });
      }

      if (viewerNext) {
        viewerNext.addEventListener('click', () => {
          showOffset(1);
        });
      }

      if (viewer) {
        viewer.addEventListener('click', event => {
          if (event.target === viewer) {
            closeViewer();
          }
        });
      }

      document.addEventListener('keydown', event => {
        if (!viewer || viewer.style.display === 'none') return;
        if (event.key === 'Escape') {
          closeViewer();
        } else if (event.key === 'ArrowLeft') {
          showOffset(-1);
        } else if (event.key === 'ArrowRight') {
          showOffset(1);
        }
      });
    });
  </script>

  <!-- ===== ÂèØÈÄâÁöÑ‚ÄúËøîÂõûÈ°∂ÈÉ®‚ÄùÊåâÈíÆ ===== -->
  <button id="backToTop" title="ÂõûÂà∞È°∂ÈÉ®">‚Üë</button>

  <script>
    // ===== ËøîÂõûÈ°∂ÈÉ®ÊåâÈíÆÈÄªËæë =====
    const topBtn = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
      // ÂΩìÈ°µÈù¢Âêë‰∏ãÊªöÂä®Ë∂ÖËøá 300px ÊòæÁ§∫ÊåâÈíÆÔºåÂê¶ÂàôÈöêËóè
      topBtn.style.display = window.scrollY > 300 ? 'block' : 'none';
    });
    topBtn.addEventListener('click', scrollToTop);
    // ÁÇπÂáªÊåâÈíÆËß¶ÂèëÂπ≥ÊªëÊªöÂä®Âà∞È°∂ÈÉ®
  </script>

  <!-- ===== Mermaid ÊµÅÁ®ãÂõæÊîØÊåÅ ===== -->
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    
    document.addEventListener("DOMContentLoaded", async () => {
      mermaid.initialize({ startOnLoad: false, theme: 'default' });

      // Êü•ÊâæÂπ∂ËΩ¨Êç¢ mermaid ‰ª£Á†ÅÂùó
      const mermaidBlocks = document.querySelectorAll('pre > code.language-mermaid');
      if (mermaidBlocks.length > 0) {
        mermaidBlocks.forEach(block => {
          const content = block.textContent;
          const pre = block.parentElement;
          const div = document.createElement('div');
          div.className = 'mermaid';
          div.textContent = content;
          pre.parentNode.replaceChild(div, pre);
        });

        // Ê∏≤Êüì
        await mermaid.run({
          querySelector: '.mermaid'
        });
      }
    });
  </script>
  <!-- ===== ÂºïÂÖ•ÁºñËæëÂô®ÂºπÁ™óÁªÑ‰ª∂ ===== -->
  <%- partial('_partial/editor-modal', {}, {cache: false}) %>
</body>
</html>
