<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <!-- 设置字符集为 UTF-8 -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 响应式布局，适配移动设备 -->

  <!-- 页面标题 -->
  <!-- 如果当前页面有标题，则显示 "页面标题 | 网站标题" -->
  <!-- 否则只显示网站标题 config.title -->
  <title>
    <%= page.title ? `${page.title} | ${config.title}` : config.title %>
  </title>

  <!-- 页面描述，用于 SEO -->
  <meta name="description" content="<%= config.description || '个人技术笔记与学习记录' %>">

  <!-- ===== 全局样式引入 ===== -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet" href="/css/post-list.css">
  <link rel="stylesheet" href="/css/page.css">
  <link rel="stylesheet" href="/css/category.css">
  <link rel="stylesheet" href="/css/archive.css">
  <link rel="stylesheet" href="/css/layout.css">
  <!-- 各模块样式，便于维护 -->

  <!-- ===== 字体与图标 ===== -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
  <!-- 网站 favicon 和 Google 字体 -->

  <!-- ===== 登录状态检查 ===== -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const onLoginPage = window.location.pathname.startsWith("/login");
      if (!onLoginPage && !localStorage.getItem("isLoggedIn")) {
        window.location.href = "/login/";
      }
      // 如果未登录且不在登录页，自动跳转到登录页
    });
  </script>
</head>

<body>
  <% if (!page.simpleLayout) { %>
    <!-- ===== 顶部导航栏 ===== -->
    <%- partial('_partial/header') %>
    <!-- 导入 header 部分模板 -->

    <!-- ===== 侧边栏 ===== -->
    <%- partial('_partial/sidebar') %>
    <!-- 导入 sidebar 部分模板 -->
  <% } %>

  <!-- ===== 主体内容区 ===== -->
  <main id="main-content">
    <%- body %>
    <!-- 渲染当前页面内容 -->
    <!-- <%- %> 保证 HTML 正常渲染，不转义 -->
  </main>

  <!-- ===== 全局脚本区域 ===== -->
  <script>
    function logout() {
      localStorage.removeItem("isLoggedIn");
      window.location.href = "/login/";
    }

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function toggleMenu() {
      const menu = document.querySelector('header.top-nav .menu');
      if (menu) {
        menu.classList.toggle('show');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const listEl = document.getElementById('pdf-list');
      const uploadInput = document.getElementById('pdf-upload-input');
      const uploadBtn = document.getElementById('pdf-upload-btn');
      const typeSelect = document.getElementById('file-type-select');

      function updateAccept() {
        if (!uploadInput || !typeSelect) return;
        if (typeSelect.value === 'image') {
          uploadInput.accept = 'image/*';
        } else {
          uploadInput.accept = 'application/pdf';
        }
      }

      async function loadResources() {
        if (!listEl) return;
        listEl.innerHTML = '<li>加载中...</li>';

        try {
          const [pdfRes, imgRes] = await Promise.all([
            fetch('https://api.github.com/repos/Sun1105/hexo-source/contents/source/pdfs'),
            fetch('https://api.github.com/repos/Sun1105/hexo-source/contents/source/images')
          ]);

          const pdfData = pdfRes.ok ? await pdfRes.json() : [];
          const imgData = imgRes.ok ? await imgRes.json() : [];

          const pdfFiles = Array.isArray(pdfData)
            ? pdfData.filter(item => item.name && item.name.toLowerCase().endsWith('.pdf'))
            : [];

          const imgFiles = Array.isArray(imgData)
            ? imgData.filter(item => item.name && /\.(png|jpe?g|gif|webp|svg)$/i.test(item.name))
            : [];

          if (!pdfFiles.length && !imgFiles.length) {
            listEl.innerHTML = '<li>暂无学习资料</li>';
            return;
          }

          const parts = [];

          if (pdfFiles.length) {
            parts.push('<li><strong>PDF 文件</strong></li>');
            pdfFiles.forEach(file => {
              const publicPath = '/' + file.path.replace(/^source\//, '');
              parts.push(
                '<li>' +
                  '<a href="' + publicPath + '" target="_blank">' +
                    '<span class="sidebar-name">' + file.name + '</span>' +
                  '</a>' +
                '</li>'
              );
            });
          }

          if (imgFiles.length) {
            parts.push('<li><strong>图片文件</strong></li>');
            imgFiles.forEach(file => {
              const publicPath = '/' + file.path.replace(/^source\//, '');
              parts.push(
                '<li>' +
                  '<a href="' + publicPath + '" target="_blank">' +
                    '<span class="sidebar-name">' + file.name + '</span>' +
                  '</a>' +
                '</li>'
              );
            });
          }

          listEl.innerHTML = parts.join('');
        } catch (e) {
          listEl.innerHTML = '<li>加载失败</li>';
        }
      }

      if (listEl) {
        loadResources();
      }

      if (typeSelect) {
        typeSelect.addEventListener('change', updateAccept);
        updateAccept();
      }

      if (uploadBtn && uploadInput) {
        uploadBtn.addEventListener('click', () => {
          if (!uploadInput.files || !uploadInput.files.length) {
            alert('请选择要上传的文件');
            return;
          }

          const file = uploadInput.files[0];
          const type = typeSelect ? typeSelect.value : 'pdf';

          if (type === 'pdf') {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
              alert('请选择 PDF 文件');
              return;
            }
          } else if (type === 'image') {
            if (!file.type.startsWith('image/')) {
              alert('请选择图片文件');
              return;
            }
          }

          const reader = new FileReader();
          reader.onload = async event => {
            const arrayBuffer = event.target.result;
            const bytes = new Uint8Array(arrayBuffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
              binary += String.fromCharCode(bytes[i]);
            }
            const base64 = btoa(binary);

            uploadBtn.disabled = true;
            uploadBtn.textContent = '上传中...';

            try {
              const res = await fetch('/api/upload-pdf', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  filename: file.name,
                  content: base64,
                  type
                })
              });

              const data = await res.json();

              if (res.ok) {
                alert('上传成功');
                uploadInput.value = '';
                loadResources();
              } else {
                alert('上传失败: ' + (data.error || JSON.stringify(data)));
              }
            } catch (err) {
              alert('请求失败: ' + err.message);
            } finally {
              uploadBtn.disabled = false;
              uploadBtn.textContent = '上传文件';
            }
          };

          reader.readAsArrayBuffer(file);
        });
      }
    });
  </script>

  <!-- ===== 可选的“返回顶部”按钮 ===== -->
  <button id="backToTop" title="回到顶部">↑</button>

  <script>
    // ===== 返回顶部按钮逻辑 =====
    const topBtn = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
      // 当页面向下滚动超过 300px 显示按钮，否则隐藏
      topBtn.style.display = window.scrollY > 300 ? 'block' : 'none';
    });
    topBtn.addEventListener('click', scrollToTop);
    // 点击按钮触发平滑滚动到顶部
  </script>

  <!-- ===== Mermaid 流程图支持 ===== -->
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    
    document.addEventListener("DOMContentLoaded", async () => {
      mermaid.initialize({ startOnLoad: false, theme: 'default' });

      // 查找并转换 mermaid 代码块
      const mermaidBlocks = document.querySelectorAll('pre > code.language-mermaid');
      if (mermaidBlocks.length > 0) {
        mermaidBlocks.forEach(block => {
          const content = block.textContent;
          const pre = block.parentElement;
          const div = document.createElement('div');
          div.className = 'mermaid';
          div.textContent = content;
          pre.parentNode.replaceChild(div, pre);
        });

        // 渲染
        await mermaid.run({
          querySelector: '.mermaid'
        });
      }
    });
  </script>
  <!-- ===== 引入编辑器弹窗组件 ===== -->
  <%- partial('_partial/editor-modal', {}, {cache: false}) %>
</body>
</html>
