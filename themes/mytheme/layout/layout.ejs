<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <!-- è®¾ç½®å­—ç¬¦é›†ä¸º UTF-8 -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- å“åº”å¼å¸ƒå±€ï¼Œé€‚é…ç§»åŠ¨è®¾å¤‡ -->

  <!-- é¡µé¢æ ‡é¢˜ -->
  <!-- å¦‚æœå½“å‰é¡µé¢æœ‰æ ‡é¢˜ï¼Œåˆ™æ˜¾ç¤º "é¡µé¢æ ‡é¢˜ | ç½‘ç«™æ ‡é¢˜" -->
  <!-- å¦åˆ™åªæ˜¾ç¤ºç½‘ç«™æ ‡é¢˜ config.title -->
  <title>
    <%= page.title ? `${page.title} | ${config.title}` : config.title %>
  </title>

  <!-- é¡µé¢æè¿°ï¼Œç”¨äº SEO -->
  <meta name="description" content="<%= config.description || 'ä¸ªäººæŠ€æœ¯ç¬”è®°ä¸å­¦ä¹ è®°å½•' %>">

  <!-- ===== å…¨å±€æ ·å¼å¼•å…¥ ===== -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet" href="/css/post-list.css">
  <link rel="stylesheet" href="/css/page.css">
  <link rel="stylesheet" href="/css/category.css">
  <link rel="stylesheet" href="/css/archive.css">
  <link rel="stylesheet" href="/css/layout.css">
  <!-- å„æ¨¡å—æ ·å¼ï¼Œä¾¿äºç»´æŠ¤ -->

  <!-- ===== å­—ä½“ä¸å›¾æ ‡ ===== -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
  <!-- ç½‘ç«™ favicon å’Œ Google å­—ä½“ -->

  <!-- ===== ç™»å½•çŠ¶æ€æ£€æŸ¥ ===== -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const onLoginPage = window.location.pathname.startsWith("/login");
      if (!onLoginPage && !localStorage.getItem("isLoggedIn")) {
        window.location.href = "/login/";
      }
      // å¦‚æœæœªç™»å½•ä¸”ä¸åœ¨ç™»å½•é¡µï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
    });
  </script>
</head>

<body>
  <% if (!page.simpleLayout) { %>
    <!-- ===== é¡¶éƒ¨å¯¼èˆªæ  ===== -->
    <%- partial('_partial/header') %>
    <!-- å¯¼å…¥ header éƒ¨åˆ†æ¨¡æ¿ -->

    <!-- ===== ä¾§è¾¹æ  ===== -->
    <%- partial('_partial/sidebar') %>
    <!-- å¯¼å…¥ sidebar éƒ¨åˆ†æ¨¡æ¿ -->
  <% } %>

  <!-- ===== ä¸»ä½“å†…å®¹åŒº ===== -->
  <main id="main-content">
    <%- body %>
    <!-- æ¸²æŸ“å½“å‰é¡µé¢å†…å®¹ -->
    <!-- <%- %> ä¿è¯ HTML æ­£å¸¸æ¸²æŸ“ï¼Œä¸è½¬ä¹‰ -->

    <section id="study-main-panel" style="display:none; margin-top:24px;">
      <h2 style="font-size:1.2rem; margin-bottom:12px;">ğŸ“š å­¦ä¹ èµ„æ–™åˆ—è¡¨</h2>
      <div id="study-main-groups">
        <div class="study-group collapsed">
          <div class="study-group-title">æ ‡åˆä¸Š</div>
          <ul id="study-main-bcs">
            <li>æš‚æ— æ–‡ä»¶</li>
          </ul>
        </div>
        <div class="study-group collapsed">
          <div class="study-group-title">æ ‡åˆä¸‹</div>
          <ul id="study-main-bcx">
            <li>æš‚æ— æ–‡ä»¶</li>
          </ul>
        </div>
        <div class="study-group collapsed">
          <div class="study-group-title">æ ‡ä¸­ä¸Š</div>
          <ul id="study-main-bzs">
            <li>æš‚æ— æ–‡ä»¶</li>
          </ul>
        </div>
        <div class="study-group collapsed">
          <div class="study-group-title">æ ‡ä¸­ä¸‹</div>
          <ul id="study-main-bzx">
            <li>æš‚æ— æ–‡ä»¶</li>
          </ul>
        </div>
        <div class="study-group collapsed">
          <div class="study-group-title">æ ‡é«˜ä¸Š</div>
          <ul id="study-main-bgs">
            <li>æš‚æ— æ–‡ä»¶</li>
          </ul>
        </div>
        <div class="study-group collapsed">
          <div class="study-group-title">æ ‡é«˜ä¸‹</div>
          <ul id="study-main-bgx">
            <li>æš‚æ— æ–‡ä»¶</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== å…¨å±€è„šæœ¬åŒºåŸŸ ===== -->
  <script>
    function logout() {
      localStorage.removeItem("isLoggedIn");
      window.location.href = "/login/";
    }

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function toggleMenu() {
      const menu = document.querySelector('header.top-nav .menu');
      if (menu) {
        menu.classList.toggle('show');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const uploadInput = document.getElementById('pdf-upload-input');
      const uploadBtn = document.getElementById('pdf-upload-btn');
      const typeSelect = document.getElementById('file-type-select');
      const categorySelect = document.getElementById('category-select');
      const studyPanel = document.getElementById('study-main-panel');
      const studyMainBtn = document.getElementById('study-main-btn');
      const sidebarStudyTitle = document.getElementById('sidebar-study-title');

      const CATEGORY_CONFIG = [
        { key: 'bcs', label: 'æ ‡åˆä¸Š' },
        { key: 'bcx', label: 'æ ‡åˆä¸‹' },
        { key: 'bzs', label: 'æ ‡ä¸­ä¸Š' },
        { key: 'bzx', label: 'æ ‡ä¸­ä¸‹' },
        { key: 'bgs', label: 'æ ‡é«˜ä¸Š' },
        { key: 'bgx', label: 'æ ‡é«˜ä¸‹' }
      ];

      function getListEl(key) {
        return document.getElementById('study-' + key);
      }

      function getMainListEl(key) {
        return document.getElementById('study-main-' + key);
      }

      function updateAccept() {
        if (!uploadInput || !typeSelect) return;
        if (typeSelect.value === 'image') {
          uploadInput.accept = 'image/*';
        } else {
          uploadInput.accept = 'application/pdf';
        }
      }

      async function loadResources() {
        for (const cat of CATEGORY_CONFIG) {
          const sideList = getListEl(cat.key);
          const mainList = getMainListEl(cat.key);

          if (sideList) {
            sideList.innerHTML = '<li>åŠ è½½ä¸­...</li>';
          }
          if (mainList) {
            mainList.innerHTML = '<li>åŠ è½½ä¸­...</li>';
          }

          try {
            const res = await fetch(
              'https://api.github.com/repos/Sun1105/hexo-source/contents/source/study/' + cat.key
            );

            if (!res.ok) {
              if (sideList) sideList.innerHTML = '<li>æš‚æ— æ–‡ä»¶</li>';
              if (mainList) mainList.innerHTML = '<li>æš‚æ— æ–‡ä»¶</li>';
              continue;
            }

            const data = await res.json();
            const files = Array.isArray(data)
              ? data.filter(item => item.name && /\.(pdf|png|jpe?g|gif|webp|svg)$/i.test(item.name))
              : [];

            if (!files.length) {
              if (sideList) sideList.innerHTML = '<li>æš‚æ— æ–‡ä»¶</li>';
              if (mainList) mainList.innerHTML = '<li>æš‚æ— æ–‡ä»¶</li>';
              continue;
            }

            const parts = files.map(file => {
              const href = file.download_url || file.html_url || '/' + file.path.replace(/^source\//, '');
              return (
                '<li>' +
                  '<a href="' + href + '" target="_blank">' +
                    '<span class="sidebar-name">' + file.name + '</span>' +
                  '</a>' +
                '</li>'
              );
            });

            if (sideList) sideList.innerHTML = parts.join('');
            if (mainList) mainList.innerHTML = parts.join('');
          } catch (e) {
            if (sideList) sideList.innerHTML = '<li>åŠ è½½å¤±è´¥</li>';
            if (mainList) mainList.innerHTML = '<li>åŠ è½½å¤±è´¥</li>';
          }
        }
      }

      loadResources();

      if (typeSelect) {
        typeSelect.addEventListener('change', updateAccept);
        updateAccept();
      }

      function showStudyPanel() {
        if (!studyPanel) return;
        const main = document.getElementById('main-content');
        if (main) {
          const children = Array.from(main.children);
          children.forEach(child => {
            if (child.id === 'study-main-panel') {
              child.style.display = 'block';
            } else {
              child.style.display = 'none';
            }
          });
          main.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      if (studyMainBtn) {
        studyMainBtn.addEventListener('click', () => {
          showStudyPanel();
          loadResources();
        });
      }

      // å·¦ä¾§â€œå­¦ä¹ èµ„æ–™â€æ ‡é¢˜åªè´Ÿè´£å±•å¼€ä¾§è¾¹æ ï¼Œä¸å†å¼ºåˆ¶åˆ‡æ¢ä¸»å†…å®¹

      const groupTitles = document.querySelectorAll('.study-group-title');
      groupTitles.forEach(title => {
        const group = title.parentElement;
        const list = group.querySelector('ul');
        if (!list) return;
        title.addEventListener('click', () => {
          group.classList.toggle('collapsed');
        });
      });

      if (uploadBtn && uploadInput) {
        uploadBtn.addEventListener('click', () => {
          if (!uploadInput.files || !uploadInput.files.length) {
            alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
            return;
          }

          const files = Array.from(uploadInput.files);
          const type = typeSelect ? typeSelect.value : 'pdf';
          const category = categorySelect ? categorySelect.value : 'bcs';

          const invalid = files.some(file => {
            if (type === 'pdf') {
              return !file.name.toLowerCase().endsWith('.pdf');
            }
            if (type === 'image') {
              return !file.type.startsWith('image/');
            }
            return true;
          });

          if (invalid) {
            if (type === 'pdf') {
              alert('ä»…æ”¯æŒæ‰©å±•åä¸º .pdf çš„æ–‡ä»¶');
            } else if (type === 'image') {
              alert('ä»…æ”¯æŒå›¾ç‰‡æ–‡ä»¶');
            } else {
              alert('æ–‡ä»¶ç±»å‹ä¸æ”¯æŒ');
            }
            return;
          }

          uploadBtn.disabled = true;
          uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';

          let successCount = 0;
          let failCount = 0;

          function uploadAt(index) {
            if (index >= files.length) {
              const message = 'ä¸Šä¼ å®Œæˆï¼šæˆåŠŸ ' + successCount + ' ä¸ªï¼Œå¤±è´¥ ' + failCount + ' ä¸ª';
              alert(message);
              uploadInput.value = '';
              loadResources();
              uploadBtn.disabled = false;
              uploadBtn.textContent = 'ä¸Šä¼ æ–‡ä»¶';
              return;
            }

            const file = files[index];
            const reader = new FileReader();

            reader.onload = event => {
              (async () => {
                try {
                  const arrayBuffer = event.target.result;
                  const bytes = new Uint8Array(arrayBuffer);
                  let binary = '';
                  for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                  }
                  const base64 = btoa(binary);

                  const res = await fetch('/api/upload-pdf', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      filename: file.name,
                      content: base64,
                      type,
                      category
                    })
                  });

                  if (res.ok) {
                    successCount += 1;
                  } else {
                    try {
                      const errData = await res.json();
                      if (errData && errData.error) {
                        console.error('ä¸Šä¼ å¤±è´¥', file.name, errData.error);
                      }
                    } catch (e2) {}
                    failCount += 1;
                  }
                } catch (e) {
                  failCount += 1;
                } finally {
                  uploadAt(index + 1);
                }
              })();
            };

            reader.onerror = () => {
              failCount += 1;
              uploadAt(index + 1);
            };

            reader.readAsArrayBuffer(file);
          }

          uploadAt(0);
        });
      }
    });
  </script>

  <!-- ===== å¯é€‰çš„â€œè¿”å›é¡¶éƒ¨â€æŒ‰é’® ===== -->
  <button id="backToTop" title="å›åˆ°é¡¶éƒ¨">â†‘</button>

  <script>
    // ===== è¿”å›é¡¶éƒ¨æŒ‰é’®é€»è¾‘ =====
    const topBtn = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
      // å½“é¡µé¢å‘ä¸‹æ»šåŠ¨è¶…è¿‡ 300px æ˜¾ç¤ºæŒ‰é’®ï¼Œå¦åˆ™éšè—
      topBtn.style.display = window.scrollY > 300 ? 'block' : 'none';
    });
    topBtn.addEventListener('click', scrollToTop);
    // ç‚¹å‡»æŒ‰é’®è§¦å‘å¹³æ»‘æ»šåŠ¨åˆ°é¡¶éƒ¨
  </script>

  <!-- ===== Mermaid æµç¨‹å›¾æ”¯æŒ ===== -->
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    
    document.addEventListener("DOMContentLoaded", async () => {
      mermaid.initialize({ startOnLoad: false, theme: 'default' });

      // æŸ¥æ‰¾å¹¶è½¬æ¢ mermaid ä»£ç å—
      const mermaidBlocks = document.querySelectorAll('pre > code.language-mermaid');
      if (mermaidBlocks.length > 0) {
        mermaidBlocks.forEach(block => {
          const content = block.textContent;
          const pre = block.parentElement;
          const div = document.createElement('div');
          div.className = 'mermaid';
          div.textContent = content;
          pre.parentNode.replaceChild(div, pre);
        });

        // æ¸²æŸ“
        await mermaid.run({
          querySelector: '.mermaid'
        });
      }
    });
  </script>
  <!-- ===== å¼•å…¥ç¼–è¾‘å™¨å¼¹çª—ç»„ä»¶ ===== -->
  <%- partial('_partial/editor-modal', {}, {cache: false}) %>
</body>
</html>
