<section class="main-section">   
  <!-- ============================
       åœ¨çº¿ç¬”è®°ç³»ç»Ÿæ¨¡å—
       åŠŸèƒ½ï¼š
         - åˆ—å‡ºå·²æœ‰æ–‡ç« 
         - æ–°å»ºæ–‡ç« 
         - ç¼–è¾‘æ–‡ç« ï¼ˆæ ‡é¢˜ã€åˆ†ç±»ã€æ ‡ç­¾ã€å†…å®¹ï¼‰
         - å®æ—¶ Markdown é¢„è§ˆ
         - ä¿å­˜åˆ° GitHub ä»“åº“ï¼Œè§¦å‘ Vercel è‡ªåŠ¨éƒ¨ç½²
  ============================ -->
  <h1 style="text-align:center;">ğŸ“’ åœ¨çº¿ç¬”è®°ç³»ç»Ÿ</h1>

  <div style="max-width:1000px; margin:20px auto;">
    <!-- æ–°å»ºæ–‡ç« æŒ‰é’® -->
    <button id="newNoteBtn" style="padding:10px 15px; background:#0078d7; color:#fff; border:none; border-radius:5px; cursor:pointer;">ğŸ“ æ–°å»ºæ–‡ç« </button>

    <!-- æ–‡ç« åˆ—è¡¨å®¹å™¨ -->
    <div id="noteList" style="margin-top:20px;"></div>

    <!-- ç¼–è¾‘å™¨å¼¹çª— -->
    <div id="editorModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
      <div style="background:#fff; width:90%; max-width:800px; margin:50px auto; padding:20px; border-radius:8px; position:relative;">
        <h2 id="editorTitle">ç¼–è¾‘æ–‡ç« </h2>

        <!-- æ ‡é¢˜è¾“å…¥æ¡† -->
        <input type="text" id="noteTitle" placeholder="æ ‡é¢˜" style="width:100%; padding:8px; margin-bottom:10px;">

        <!-- åˆ†ç±»è¾“å…¥æ¡† -->
        <input type="text" id="noteCategory" placeholder="åˆ†ç±»" style="width:100%; padding:8px; margin-bottom:10px;">

        <!-- æ ‡ç­¾è¾“å…¥æ¡† -->
        <input type="text" id="noteTags" placeholder="æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”" style="width:100%; padding:8px; margin-bottom:10px;">

        <!-- å†…å®¹è¾“å…¥æ¡† -->
        <textarea id="noteContent" rows="15" style="width:100%; padding:8px;"></textarea>

        <!-- ä¿å­˜/å–æ¶ˆæŒ‰é’® -->
        <div style="margin-top:10px; display:flex; gap:10px;">
          <button id="saveNoteBtn" style="flex:1; padding:10px; background:#28a745; color:#fff; border:none; border-radius:5px; cursor:pointer;">ğŸ’¾ ä¿å­˜</button>
          <button id="cancelEditBtn" style="flex:1; padding:10px; background:#dc3545; color:#fff; border:none; border-radius:5px; cursor:pointer;">âŒ å–æ¶ˆ</button>
        </div>

        <!-- Markdown å®æ—¶é¢„è§ˆ -->
        <div id="preview" style="margin-top:20px; padding:10px; border:1px solid #ddd; border-radius:5px;"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
  const owner = "Sun1105";              // æ›¿æ¢æˆä½ çš„ GitHub ç”¨æˆ·å
  const repo = "hexo-source";           // æ›¿æ¢æˆä½ çš„ä»“åº“å
  const postsDir = "source/_posts";     // Hexo æ–‡ç« ç›®å½•
  let editingNote = null;               // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡ç« å¯¹è±¡

  const noteListDiv = document.getElementById('noteList');
  const editorModal = document.getElementById('editorModal');
  const noteTitle = document.getElementById('noteTitle');
  const noteCategory = document.getElementById('noteCategory'); // åˆ†ç±»è¾“å…¥æ¡†
  const noteTags = document.getElementById('noteTags');
  const noteContent = document.getElementById('noteContent');
  const saveNoteBtn = document.getElementById('saveNoteBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');
  const previewDiv = document.getElementById('preview');

  // é€šç”¨ fetchJson å·¥å…·å‡½æ•°
  async function fetchJson(url, options = {}) {
    const res = await fetch(url, options);
    const contentType = res.headers.get("content-type");
    if (contentType && contentType.includes("application/json")) {
      const data = await res.json();
      if (!res.ok) throw new Error(JSON.stringify(data));
      return data;
    } else {
      const text = await res.text();
      throw new Error("æœåŠ¡å™¨è¿”å›çš„ä¸æ˜¯ JSON: " + text.slice(0,100));
    }
  }

  // ========================
  // 1ï¸âƒ£ åˆ—å‡ºæ–‡ç« åˆ—è¡¨
  // ========================
  async function loadNotes() {
    noteListDiv.innerHTML = "åŠ è½½ä¸­...";
    try {
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsDir}`);
      const data = await res.json();
      if(res.ok){
        noteListDiv.innerHTML = "";
        data.forEach(file => {
        if(file.name.endsWith(".md")){
          const div = document.createElement('div');
          div.className = "note-item";

          // å·¦ä¾§ï¼šå›¾æ ‡ + æ–‡ä»¶å
          const left = document.createElement('div');
          left.style.display = "flex";
          left.style.alignItems = "center";

          const icon = document.createElement('span');
          icon.className = "note-icon";
          icon.textContent = "ğŸ“„";

          const title = document.createElement('span');
          title.className = "note-title";
          title.textContent = file.name;

          left.appendChild(icon);
          left.appendChild(title);

          // å³ä¾§ï¼šé™„åŠ ä¿¡æ¯ï¼ˆæ¯”å¦‚æ›´æ–°æ—¶é—´ï¼‰
          const meta = document.createElement('span');
          meta.className = "note-meta";
          meta.textContent = new Date(file.git_url ? file.git_url : Date.now()).toLocaleDateString();

          div.appendChild(left);
          div.appendChild(meta);

          div.addEventListener('click', () => openEditor(file));
          noteListDiv.appendChild(div);
        }
        });
      } else {
        noteListDiv.innerHTML = "âŒ è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥ï¼š" + JSON.stringify(data);
      }
    } catch(err){
      noteListDiv.innerHTML = "âŒ ç½‘ç»œé”™è¯¯ï¼š" + err.message;
    }
  }

  // ========================
  // 2ï¸âƒ£ æ‰“å¼€ç¼–è¾‘å™¨
  // ========================
  async function openEditor(file){
    editingNote = file;
    try {
      const res = await fetch(file.download_url);
      const contentText = await res.text();
      const shaRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsDir}/${file.name}`);
      const shaData = await shaRes.json();
      editingNote.sha = shaData.sha;

      // å¡«å……ç¼–è¾‘å™¨
      noteTitle.value = contentText.match(/title:\s*(.*)/)?.[1] || file.name;
      noteCategory.value = contentText.match(/category:\s*(.*)/)?.[1] || ""; // åˆ†ç±»
      noteTags.value = contentText.match(/tags:\s*\[(.*)\]/)?.[1] || "";
      noteContent.value = contentText.split('---').slice(2).join('---').trim();

      previewDiv.innerHTML = marked.parse(noteContent.value);
      editorModal.style.display = "block";
    } catch(err){
      alert("âŒ æ‰“å¼€ç¼–è¾‘å™¨å¤±è´¥ï¼š" + err.message);
    }
  }

  // ========================
  // 3ï¸âƒ£ æ–°å»ºæ–‡ç« 
  // ========================
  document.getElementById('newNoteBtn').addEventListener('click', () => {
    editingNote = null;
    noteTitle.value = "";
    noteCategory.value = "";
    noteTags.value = "";
    noteContent.value = "";
    previewDiv.innerHTML = "";
    editorModal.style.display = "block";
  });

  // ========================
  // 4ï¸âƒ£ ä¿å­˜æ–‡ç« 
  // ========================
  saveNoteBtn.addEventListener('click', async () => {
    const title = noteTitle.value.trim();
    const category = noteCategory.value.trim(); // åˆ†ç±»
    const tags = noteTags.value.split(',').map(t=>t.trim()).filter(Boolean);
    const content = noteContent.value.trim();

    if(!title || !content){
      alert("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
      return;
    }

  const mdContent = `---
  title: ${title}
  category: ${category}
  tags: [${tags.join(',')}]
  date: ${new Date().toISOString()}
  ---

  ${content}
  `;

    try {
      let path, sha, message;
      if(editingNote){
        path = `${postsDir}/${editingNote.name}`;
        sha = editingNote.sha;
        message = `ç¼–è¾‘æ–‡ç« : ${title}`;
      } else {
        const fileName = `${Date.now()}-${title.replace(/\s+/g,'-')}.md`;
        path = `${postsDir}/${fileName}`;
        sha = undefined;
        message = `æ–°å»ºæ–‡ç« : ${title}`;
      }

      const res = await fetch(editingNote ? '/api/edit-note' : '/api/new-note', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ path, sha, content: mdContent, message })
      });

      const data = await res.json();
      if(res.ok){
        alert('âœ… ä¿å­˜æˆåŠŸï¼è¯·ç¨ç­‰ Vercel è‡ªåŠ¨éƒ¨ç½²ã€‚');
        editorModal.style.display = "none";
        loadNotes();
      } else {
        alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + JSON.stringify(data.error));
      }
    } catch(err){
      alert("âŒ ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯ï¼š" + err.message);
    }
  });

  // ========================
  // 5ï¸âƒ£ å–æ¶ˆç¼–è¾‘
  // ========================
  cancelEditBtn.addEventListener('click', () => {
    editorModal.style.display = "none";
  });

  // ========================
  // 6ï¸âƒ£ å®æ—¶ Markdown é¢„è§ˆ
  // ========================
  noteContent.addEventListener('input', () => {
    previewDiv.innerHTML = marked.parse(noteContent.value);
  });

  // ========================
  // 7ï¸âƒ£ åˆå§‹åŒ–åŠ è½½æ–‡ç« åˆ—è¡¨
  // ========================
  loadNotes();
  </script>
  <style>
    /* æ–‡ä»¶åˆ—è¡¨æ•´ä½“å®¹å™¨ */
    #noteList {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* å•ä¸ªæ–‡ç« é¡¹ */
    .note-item {
      padding: 12px 16px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #fafafa;
      transition: all 0.2s ease;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* é¼ æ ‡æ‚¬åœæ•ˆæœ */
    .note-item:hover {
      background: #f0f8ff;
      border-color: #0078d7;
      transform: translateY(-2px);
      cursor: pointer;
    }

    /* æ–‡ä»¶å */
    .note-title {
      font-weight: 600;
      color: #333;
    }

    /* æ–‡ä»¶å›¾æ ‡ */
    .note-icon {
      margin-right: 8px;
      color: #0078d7;
    }

    /* æ—¶é—´æˆ³æˆ–é™„åŠ ä¿¡æ¯ */
    .note-meta {
      font-size: 12px;
      color: #666;
    }
  </style>
</section>