name: Deploy Hexo Blog to GitHub Pages

# è§¦å‘æ¡ä»¶ï¼š
# 1. å½“ main åˆ†æ”¯æœ‰ push æ—¶è‡ªåŠ¨è§¦å‘
# 2. ä¹Ÿå¯ä»¥æ‰‹åŠ¨åœ¨ Actions é¡µé¢ç‚¹å‡» "Run workflow" è§¦å‘
on:
  push:
    branches:
      - main
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡åœ¨è·‘
# å¦‚æœæœ‰æ–°çš„éƒ¨ç½²è§¦å‘ï¼Œä¼šè‡ªåŠ¨å–æ¶ˆä¹‹å‰æœªå®Œæˆçš„éƒ¨ç½²ï¼Œé¿å…èµ„æºæµªè´¹
concurrency:
  group: hexo-deploy
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„ Ubuntu Runner ç¯å¢ƒ

    steps:
      # 1ï¸âƒ£ æ‹‰å–æºç 
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´ git å†å²ï¼Œé¿å…æŸäº› Hexo æ’ä»¶ä¾èµ–å†å²æäº¤æ—¶æŠ¥é”™

      # 2ï¸âƒ£ è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # ä½¿ç”¨ Node.js 20 LTS ç‰ˆæœ¬
          cache: 'npm'        # å¼€å¯ npm ç¼“å­˜ï¼ŒåŠ å¿«åç»­æ„å»ºé€Ÿåº¦

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci  # ä½¿ç”¨ npm ciï¼Œä¸¥æ ¼æŒ‰ç…§ package-lock.json å®‰è£…ï¼Œä¿è¯ä¾èµ–ä¸€è‡´æ€§

      # 4ï¸âƒ£ æ„å»º Hexo é™æ€æ–‡ä»¶
      - name: Generate site (Hexo)
        env:
          CI: true  # é¿å…æŸäº›ä¾èµ–åœ¨ CI ç¯å¢ƒä¸‹äº¤äº’å¼æé—®
        run: |
          npx hexo version || true   # æ‰“å° Hexo ç‰ˆæœ¬ï¼Œæ–¹ä¾¿è°ƒè¯•
          npx hexo clean             # æ¸…ç†æ—§çš„ public æ–‡ä»¶ï¼Œé¿å…ç¼“å­˜é—®é¢˜
          npx hexo generate          # ç”Ÿæˆæ–°çš„é™æ€æ–‡ä»¶åˆ° ./public

      # 5ï¸âƒ£ éƒ¨ç½²åˆ° GitHub Pages ä»“åº“
      - name: Deploy to Pages (push to sun1105.github.io)
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.PUBLISH_TOKEN }}   # <- ä½¿ç”¨ PAT æ›¿ä»£ GITHUB_TOKEN
          publish_dir: ./public                      # Hexo ç”Ÿæˆçš„é™æ€æ–‡ä»¶ç›®å½•
          external_repository: Sun1105/sun1105.github.io  # ç›®æ ‡ä»“åº“ï¼ˆå­˜æ”¾é™æ€é¡µé¢ï¼‰
          publish_branch: main                       # éƒ¨ç½²åˆ°ç›®æ ‡ä»“åº“çš„ main åˆ†æ”¯
          commit_message: "ğŸš€ Auto deploy from blog-source via Actions"
          # è‡ªå®šä¹‰ commit messageï¼Œæ–¹ä¾¿åŒºåˆ†æ˜¯è‡ªåŠ¨éƒ¨ç½²
